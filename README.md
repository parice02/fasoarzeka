# FASO ARZEKA Mobile Money Payment API (Burkina Faso)

[![Python 3.9+](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

API client Python non officiel pour les paiements mobiles FASO ARZEKA au Burkina Faso.
Client robuste, production-ready avec gestion automatique des erreurs, retry automatique, et r√©authentification automatique.

## ‚ú® Fonctionnalit√©s principales

- ‚úÖ **Authentification s√©curis√©e** avec gestion automatique des tokens
- ‚úÖ **R√©authentification automatique** quand le token expire
- ‚úÖ **Gestion compl√®te des erreurs** avec exceptions personnalis√©es
- ‚úÖ **Retry automatique** avec backoff exponentiel
- ‚úÖ **Logging int√©gr√©** pour tra√ßabilit√© compl√®te
- ‚úÖ **Session persistante** pour meilleures performances
- ‚úÖ **Type hints complets** pour meilleure auto-compl√©tion
- ‚úÖ **Context manager** pour gestion automatique des ressources
- ‚úÖ **Validation des tokens** avec informations d'expiration
- ‚úÖ **Tests unitaires complets** avec couverture >90%

## üìã Pr√©requis

1. **Compte API Arzeka Money**
   - Username
   - Password
   - Hash Secret
   - Merchant ID

2. **Certificats SSL** (si fournis par l'op√©rateur)

3. **Python 3.9 ou sup√©rieur**

## üì¶ D√©pendances

```txt
requests>=2.31.0
setuptools
urllib3
```

Le client n√©cessite Python 3.9 ou sup√©rieur.

## üöÄ Installation

```bash
# Avec pip
pip install git+https://github.com/parice02/fasoarzeka.git

# Avec poetry
poetry add git+https://github.com/parice02/fasoarzeka.git

# Installation en mode d√©veloppement
git clone https://github.com/parice02/fasoarzeka.git
cd fasoarzeka
pip install -e .
```

## üéØ Guide de d√©marrage rapide

### Option 1 : Utilisation avec fonctions de convenance (Recommand√©)

```python
from arzeka import authenticate, initiate_payment, check_payment

# 1. Authentifiez-vous une fois
auth = authenticate("your_username", "your_password")
print(f"Token expires in: {auth['expires_in']} seconds")

# 2. Initiez un paiement
payment_data = {
    "amount": 1000,  # Montant en FCFA (minimum 100)
    "merchant_id": "MERCHANT_123",
    "additional_info": {
        "first_name": "Jean",
        "last_name": "Dupont",
        "mobile": "22670123456"  # Num√©ro avec indicatif
    },
    "mapped_order_id": "eT20220923.203221.24732",
    "hash_secret": "your_hash_secret",
    "link_for_update_status": "https://example.com/webhook",
    "link_back_to_calling_website": "https://example.com/return"
}

response = initiate_payment(payment_data)
print(f"URL to redirect user for payment: {response['url']}")

# 3. V√©rifiez le statut du paiement
payment_response = check_payment(payment_data['mapped_order_id'])
print(f"Payment status: {payment_response['status']}")
```

### Option 2 : Utilisation avec instance de classe

```python
from arzeka import ArzekaPayment

# Utilisez le context manager pour gestion automatique
with ArzekaPayment() as client:
    # 1. Authentification
    auth = client.authenticate("your_username", "your_password")

    # 2. V√©rifiez la validit√© du token
    if client.is_token_valid():
        print("Token is valid")

    # 3. Initiez un paiement
    response = client.initiate_payment(
        amount=1000,
        merchant_id="MERCHANT_123",
        additional_info={
            "first_name": "Jean",
            "last_name": "Dupont",
            "mobile": "70123456"
        },
        mapped_order_id="eT20220923.203221.24732",
        hash_secret="your_hash_secret",
        link_for_update_status="https://example.com/webhook",
        link_back_to_calling_website="https://example.com/return"
    )

    # 4. V√©rifiez le statut
    status = client.check_payment("eT20220923.203221.24732")

# Le client est automatiquement ferm√©
```

## üìö Exemples d√©taill√©s

### Authentification et gestion des tokens

```python
from arzeka import ArzekaPayment

client = ArzekaPayment()

# Authentification
auth = client.authenticate("username", "password")
print(f"Access Token: {auth['access_token']}")
print(f"Token Type: {auth['token_type']}")
print(f"Expires In: {auth['expires_in']} seconds")

# V√©rifier la validit√© du token
if client.is_token_valid():
    print("Token is still valid")
else:
    print("Token has expired")

# Obtenir des informations d√©taill√©es sur le token
info = client.get_token_expiry_info()
print(f"Expires in {info['expires_in_minutes']:.1f} minutes")
print(f"Is expired: {info['is_expired']}")

client.close()
```

### R√©authentification automatique

```python
from arzeka import ArzekaPayment

client = ArzekaPayment()
client.authenticate("username", "password")

# Faites plusieurs requ√™tes sur une longue p√©riode
# La r√©authentification est AUTOMATIQUE si le token expire

for i in range(10):
    # Pas besoin de v√©rifier la validit√© du token !
    # Le client se r√©authentifie automatiquement si n√©cessaire
    response = client.initiate_payment(
        amount=1000,
        merchant_id="MERCHANT_123",
        additional_info={...},
        hash_secret="secret",
        link_for_update_status="https://...",
        link_back_to_calling_website="https://..."
    )
    print(f"Payment {i+1}: {response['mappedOrderId']}")

client.close()
```

### Initialisation de paiement avec re√ßu

```python
from arzeka import initiate_payment, authenticate

# Authentifiez-vous d'abord
authenticate("username", "password")

# Paiement avec g√©n√©ration de re√ßu
payment_data = {
    "amount": 5000,
    "merchant_id": "MERCHANT_123",
    "additional_info": {
        "first_name": "Marie",
        "last_name": "Kabor√©",
        "mobile": "70987654",
        "generateReceipt": True,  # Activer la g√©n√©ration de re√ßu
        "paymentDescription": "Facture N¬∞12345",
        "accountingOffice": "Bureau Principal",
        "accountantName": "Jean Traor√©",
        "address": "Ouagadougou, Burkina Faso"
    },
    "hash_secret": "your_secret",
    "link_for_update_status": "https://example.com/webhook",
    "link_back_to_calling_website": "https://example.com/return",
    "mapped_order_id": "ORDER-2025-001"  # ID personnalis√©
}

response = initiate_payment(payment_data)
print(f"Payment URL: {response.get('payment_url')}")
print(f"Order ID: {response.get('mappedOrderId')}")
```

### V√©rification de paiement

```python
from arzeka import check_payment, authenticate

authenticate("username", "password")

# V√©rification simple
status = check_payment("ORDER-2025-001")
print(f"Status: {status}")

# V√©rification avec transaction ID
status = check_payment(
    mapped_order_id="ORDER-2025-001",
    transaction_id="TXN-12345"
)
print(f"Transaction Status: {status}")
```

### Utilisation des fonctions utilitaires

```python
from arzeka import get_reference, format_msisdn, validate_phone_number

# G√©n√©rer un ID de r√©f√©rence unique
ref = get_reference()
print(f"Reference: {ref}")  # Ex: REF-20251023-123456

# Formater un num√©ro de t√©l√©phone
msisdn = format_msisdn("70 12 34 56")
print(f"Formatted: {msisdn}")  # 22670123456

# Valider un num√©ro burkinab√®
is_valid = validate_phone_number("70123456")
print(f"Valid: {is_valid}")  # True
```

## üîí Gestion des erreurs

Le client fournit des exceptions sp√©cifiques pour diff√©rents types d'erreurs :

```python
from arzeka import (
    ArzekaPayment,
    ArzekaPaymentError,
    ArzekaConnectionError,
    ArzekaValidationError,
    ArzekaAPIError,
    ArzekaAuthenticationError
)

client = ArzekaPayment()

try:
    # Tentative d'authentification
    client.authenticate("username", "password")

    # Tentative de paiement
    response = client.initiate_payment(
        amount=1000,
        merchant_id="MERCHANT_123",
        additional_info={...},
        hash_secret="secret",
        link_for_update_status="https://...",
        link_back_to_calling_website="https://..."
    )

except ArzekaAuthenticationError as e:
    print(f"Authentication failed: {e}")

except ArzekaValidationError as e:
    print(f"Invalid data: {e}")

except ArzekaConnectionError as e:
    print(f"Connection error: {e}")

except ArzekaAPIError as e:
    print(f"API error: {e}")
    print(f"Status code: {e.status_code}")
    print(f"Response: {e.response_data}")

except ArzekaPaymentError as e:
    print(f"General error: {e}")

finally:
    client.close()
```

## ‚öôÔ∏è Configuration

### Variables d'environnement (recommand√©)

```bash
# .env
ARZEKA_USERNAME=your_username
ARZEKA_PASSWORD=your_password
ARZEKA_MERCHANT_ID=MERCHANT_123
ARZEKA_HASH_SECRET=your_hash_secret
ARZEKA_BASE_URL=https://pwg-test.fasoarzeka.com/AvepayPaymentGatewayUI/avepay-payment/
```

```python
import os
from arzeka import ArzekaPayment

client = ArzekaPayment(
    base_url=os.getenv('ARZEKA_BASE_URL'),
    timeout=30
)

client.authenticate(
    os.getenv('ARZEKA_USERNAME'),
    os.getenv('ARZEKA_PASSWORD')
)
```

### Configuration du logging

```python
import logging
from arzeka import ArzekaPayment

# Configurer le niveau de log
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

client = ArzekaPayment()
# Les logs d√©taill√©s seront affich√©s
```

## üß™ Tests

Le projet inclut des tests unitaires complets :

```bash
# Ex√©cuter tous les tests
python -m pytest test/

# Ex√©cuter avec couverture
python -m pytest test/ --cov=arzeka --cov-report=html

# Ex√©cuter un test sp√©cifique
python -m pytest test/test.py::TestArzekaPayment::test_authenticate

# Mode verbose
python -m pytest test/ -v
```

## üìñ Documentation compl√®te

- **[Guide de d√©marrage rapide](docs/QUICKSTART.md)** - Commencer en 5 minutes
- **[Guide d'authentification](docs/AUTHENTICATION.md)** - Tout sur l'authentification
- **[Validation des tokens](docs/TOKEN_VALIDATION.md)** - Gestion des tokens
- **[R√©authentification automatique](docs/AUTO_REAUTH.md)** - Fonctionnalit√© avanc√©e
- **[Exemples de code](examples/)** - Exemples pratiques
  - `authentication_example.py` - Exemples d'authentification
  - `token_validation_example.py` - Validation de tokens
  - `shared_client_example.py` - Instance partag√©e
  - `auto_reauth_example.py` - R√©authentification automatique

## üèóÔ∏è Architecture

```
arzeka-payment/
‚îú‚îÄ‚îÄ arzeka.py              # Module principal
‚îú‚îÄ‚îÄ utils.py               # Fonctions utilitaires
‚îú‚îÄ‚îÄ __init__.py            # Exports publics
‚îú‚îÄ‚îÄ requirements.txt       # D√©pendances
‚îú‚îÄ‚îÄ setup.py              # Configuration d'installation
‚îú‚îÄ‚îÄ pyproject.toml        # Configuration Poetry
‚îú‚îÄ‚îÄ docs/                 # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ QUICKSTART.md
‚îÇ   ‚îú‚îÄ‚îÄ AUTHENTICATION.md
‚îÇ   ‚îî‚îÄ‚îÄ TOKEN_VALIDATION.md
‚îú‚îÄ‚îÄ examples/             # Exemples de code
‚îÇ   ‚îú‚îÄ‚îÄ authentication_example.py
‚îÇ   ‚îú‚îÄ‚îÄ token_validation_example.py
‚îÇ   ‚îú‚îÄ‚îÄ shared_client_example.py
‚îÇ   ‚îî‚îÄ‚îÄ auto_reauth_example.py
‚îî‚îÄ‚îÄ test/                 # Tests unitaires
    ‚îî‚îÄ‚îÄ test.py
```

## üîß Classes et Exceptions

### Classes principales

- **`ArzekaPayment`** - Client principal pour interactions API
- **`BasePayment`** - Classe de base avec gestion session et requ√™tes

### Exceptions personnalis√©es

- **`ArzekaPaymentError`** - Exception de base
- **`ArzekaConnectionError`** - Erreurs de connexion r√©seau
- **`ArzekaValidationError`** - Erreurs de validation de donn√©es
- **`ArzekaAPIError`** - Erreurs retourn√©es par l'API
- **`ArzekaAuthenticationError`** - Erreurs d'authentification

## üöÄ Fonctionnalit√©s avanc√©es

### 1. Retry automatique avec backoff exponentiel

```python
# Le client r√©essaie automatiquement en cas d'erreur r√©seau
# - Maximum 3 tentatives
# - Backoff exponentiel (1s, 2s, 4s)
# - Status codes: 429, 500, 502, 503, 504
client = ArzekaPayment()
# Les retries sont automatiques !
```

### 2. Session persistante avec connection pooling

```python
# Les connexions HTTP sont r√©utilis√©es pour meilleures performances
client = ArzekaPayment()
# La session est automatiquement g√©r√©e
```

### 3. Context manager

```python
# Gestion automatique des ressources
with ArzekaPayment() as client:
    client.authenticate("user", "pass")
    response = client.initiate_payment(...)
# Fermeture automatique de la session
```

### 4. Instance partag√©e pour fonctions de convenance

```python
from arzeka import authenticate, initiate_payment, get_shared_client, close_shared_client

# Les fonctions partagent une m√™me instance
authenticate("user", "pass")
initiate_payment(payment_data)

# Acc√©der √† l'instance partag√©e
client = get_shared_client()
print(client.is_token_valid())

# Nettoyer l'instance partag√©e
close_shared_client()
```

## üí° Bonnes pratiques

### 1. Utiliser les variables d'environnement

```python
import os
from arzeka import authenticate

username = os.getenv('ARZEKA_USERNAME')
password = os.getenv('ARZEKA_PASSWORD')
authenticate(username, password)
```

### 2. Utiliser le context manager

```python
with ArzekaPayment() as client:
    client.authenticate("user", "pass")
    # ... op√©rations ...
# Nettoyage automatique
```

### 3. G√©rer les exceptions sp√©cifiques

```python
try:
    response = client.initiate_payment(...)
except ArzekaValidationError:
    # Donn√©es invalides
except ArzekaAuthenticationError:
    # Probl√®me d'authentification
except ArzekaConnectionError:
    # Probl√®me r√©seau
```

### 4. V√©rifier les tokens avant longues op√©rations

```python
if client.is_token_valid(margin_seconds=300):  # 5 minutes
    # Token valide pour au moins 5 minutes
    long_operation()
```

### 5. Utiliser le logging pour debug

```python
import logging
logging.basicConfig(level=logging.DEBUG)
# Logs d√©taill√©s des requ√™tes
```

## üîç API Reference

### ArzekaPayment

```python
class ArzekaPayment(base_url: str = BASE_URL, timeout: int = 30)
```

#### M√©thodes

- **`authenticate(username, password)`** - Authentification et obtention du token
- **`initiate_payment(...)`** - Initialiser un paiement
- **`check_payment(mapped_order_id, transaction_id)`** - V√©rifier statut paiement
- **`is_token_valid(margin_seconds=60)`** - V√©rifier validit√© du token
- **`get_token_expiry_info()`** - Obtenir infos d√©taill√©es sur expiration
- **`close()`** - Fermer la session

### Fonctions utilitaires

- **`get_reference()`** - G√©n√©rer ID de r√©f√©rence unique
- **`format_msisdn(phone)`** - Formater num√©ro de t√©l√©phone
- **`validate_phone_number(phone)`** - Valider num√©ro burkinab√®

### Fonctions de convenance

- **`authenticate(username, password, base_url, timeout)`** - Authentification
- **`initiate_payment(payment_data, base_url, timeout)`** - Initialiser paiement
- **`check_payment(mapped_order_id, transaction_id, base_url, timeout)`** - V√©rifier paiement
- **`get_shared_client()`** - Obtenir instance partag√©e
- **`close_shared_client()`** - Fermer instance partag√©e

## üìä Statut du projet

- ‚úÖ Authentification s√©curis√©e
- ‚úÖ Initialisation de paiements
- ‚úÖ V√©rification de statut
- ‚úÖ Gestion compl√®te des erreurs
- ‚úÖ Retry automatique
- ‚úÖ R√©authentification automatique
- ‚úÖ Tests unitaires (>90% couverture)
- ‚úÖ Documentation compl√®te
- ‚úÖ Type hints complets
- ‚úÖ Logging int√©gr√©
- ‚è≥ Publication sur PyPI (√† venir)

## ü§ù Contribution

Les contributions sont les bienvenues ! Voici comment contribuer :

1. **Fork** le projet
2. **Cr√©ez** une branche pour votre fonctionnalit√© (`git checkout -b feature/AmazingFeature`)
3. **Committez** vos changements (`git commit -m 'Add some AmazingFeature'`)
4. **Pushez** vers la branche (`git push origin feature/AmazingFeature`)
5. **Ouvrez** une Pull Request

### Guidelines de contribution

- Suivre le style de code existant
- Ajouter des tests pour nouvelles fonctionnalit√©s
- Mettre √† jour la documentation
- S'assurer que tous les tests passent

## üìù Changelog

Voir [CHANGELOG.md](CHANGELOG.md) pour l'historique d√©taill√© des modifications.

## üìÑ Licence

Ce projet est sous licence MIT. Voir le fichier [LICENSE](LICENSE) pour plus de d√©tails.

## üë• Auteur

**Mohamed Zeba** - [m.zeba@mzeba.dev](mailto:m.zeba@mzeba.dev)

## üôè Remerciements

- L'√©quipe Arzeka pour l'API
- La communaut√© Python du Burkina Faso
- Tous les contributeurs

## üìû Support

- **Issues** : [GitHub Issues](https://github.com/parice02/fasoarzeka/issues)
- **Email** : m.zeba@mzeba.dev
- **Documentation** : [GitHub Wiki](https://github.com/parice02/fasoarzeka/wiki)

## ‚ö†Ô∏è Avertissement

Ceci est un client **non officiel** pour l'API Arzeka. Utilisez-le √† vos propres risques.
Assurez-vous de respecter les conditions d'utilisation de l'API Arzeka.

## üåü Soutenez le projet

Si ce projet vous aide, n'oubliez pas de lui donner une ‚≠ê sur GitHub !

---

**Note importante** : Ce client utilise l'environnement de test par d√©faut.
Pour la production, assurez-vous de configurer l'URL de production :

```python
from arzeka import ArzekaPayment

client = ArzekaPayment(base_url="https://pwg.fasoarzeka.com/...")
```
